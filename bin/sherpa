#!/usr/bin/env ruby
require 'methadone'
require 'csv'
require 'json'
require 'lll'

require_relative '../lib/sherpa'

include Methadone::Main

ENV['DEBUG'] = 'true'

main do |file_name|
  @file_name = file_name
  @counts = Hash.new(0)
  @parsed_citations = []
  @unparsed_citations = []

  Progress.init true, line_count

  need_to_skip_header = true
  File.foreach @file_name do |line|
    if need_to_skip_header
      need_to_skip_header = false
      next
    end

    begin
      row = get_csv_row line
      break unless row
      Progress.tally
      @counts[:valid_csv] += 1
    rescue
      @counts[:invalid_csv] += 1
      next
    end

    unless citation = get_fields_from_row(row)
      @counts[:no_citation] += 1
      next
    end

    begin
      citation = parse_citation citation
      @parsed_citations << citation unless file_is_really_big
      @counts[:parsed] += 1
    rescue Citrus::ParseError
      @unparsed_citations << citation unless file_is_really_big
      @counts[:unparsed] += 1
    end

    show_progress
  end

  unless file_is_really_big
    write_citations @parsed_citations, 'parsed.json'
    write_citations @unparsed_citations.sort_by{|a| a[:citation]}.uniq, 'unparsed.json'
    write_comparisons
  end

  show_results

end

def file_is_really_big
  line_count > 2000
end

def line_count
  @line_count ||= `wc '#{@file_name}' | cut -c -9`.to_i
end

def make_file_name new_extension
  file_name_without_extension = @file_name[0...@file_name.rindex('.')]
  file_name_without_extension + '.' + new_extension
end

def get_csv_row line
  CSV.parse_line line, col_sep: "\t"
end

def spreadsheet_column_to_offset letter
  letter.ord - 'A'.ord
end

def get_fields_from_row row
  citation = row[spreadsheet_column_to_offset('M')]
  return unless citation
  {citation: citation,
   them: {
    title: row[spreadsheet_column_to_offset('P')],
    volume: row[spreadsheet_column_to_offset('Q')],
    date: row[spreadsheet_column_to_offset('S')],
    pages: row[spreadsheet_column_to_offset('T')],
  }}
end

def parse_citation citation
  citation.merge! Sherpa::Parser.parse citation[:citation]
end

def write_citations citations, extension
  File.open make_file_name(extension), 'w' do |file|
    file.puts '['
    for citation in citations
      file.puts citation.to_json
    end
    file.puts ']'
  end
end

def write_comparisons
  File.open make_file_name('comparison.html'), 'w' do |file|
    file.write Sherpa::Formatter.format_comparisons @parsed_citations
  end
end

def show_progress
  return unless line_count >= 2000
  return if Progress.processed_count % 10_000 != 0
  message = "#{Progress.processed_count} lines, " +
            "#{Progress.percent(@counts[:parsed])} parsed, " +
            "#{Progress.time_left}"
  Progress.puts message
end

def show_results
  Progress.show_results
  Progress.show_count @counts[:parsed], Progress.processed_count, 'parsed'
end

description "SHERborn PArser - Parses the citation field of Sherborn's Index Animalium"
arg :file_name

version Sherpa::VERSION

go!
